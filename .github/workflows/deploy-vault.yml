name: Deploy Vault Cluster

# vault cluster is already deployed, do not run it untill specified
on:
  workflow_dispatch:
  push:
    branches:
      - naitik/reinit_vault

jobs:
  deploy:
    name: Deploy Vault Node
    runs-on: ubuntu-latest
    env:
      SERVER1_IP: ${{ secrets.SERVER1_IP }}
      SERVER2_IP: ${{ secrets.SERVER2_IP }}
      SERVER3_IP: ${{ secrets.SERVER3_IP }}

    strategy:
      matrix:
        server:
            - node_id: vault-1
              server_ip: $SERVER1_IP
              retry1: $SERVER2_IP
              retry2: $SERVER3_IP

            - node_id: vault-2
              server_ip: $SERVER2_IP
              retry1: $SERVER1_IP
              retry2: $SERVER3_IP

            - node_id: vault-3
              server_ip: $SERVER3_IP
              retry1: $SERVER1_IP
              retry2: $SERVER2_IP

      max-parallel: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_BARE_METAL_GITHUB_ACTIONS_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ matrix.server.server_ip }} >> ~/.ssh/known_hosts

      - name: Check server connectivity
        run: |
          ssh -o ConnectTimeout=10 root@${{ matrix.server.server_ip }} "echo 'Server connection successful'"

      - name: Sync deployment files to server
        run: |
          rsync -avz --delete \
            ./deploy/ \
            root@${{matrix.server.server_ip}}:/home/vault/deploy/

      - name: Deploy to ${{ matrix.server.server_ip }} with docker compose
        env:
          SERVER_IP: ${{ matrix.server.server_ip }}
        run: |
          # Remove old vault data, testing reinitiation of vault cluster
          ssh root@${{ matrix.server.server_ip }} "rm -rf /home/vault/{config,data,logs}"
          
          # Create deployment directory if not exists
          ssh root@${{ matrix.server.server_ip }} "mkdir -p /home/vault/{config,data,logs}"
          
          ssh root@${{ matrix.server.server_ip }} "chown -R 100:100 /home/vault/{config,data,logs}"
          ssh root@${{ matrix.server.server_ip }} "chown -R root:root /home/tls"
          ssh root@${{ matrix.server.server_ip }} "chmod 644 /home/tls/*key.pem"
          ssh root@${{ matrix.server.server_ip }} "chmod 644 /home/tls/*cert.pem"

          # Copy docker-compose.yml to base directory
          ssh root@${{ matrix.server.server_ip }} "cp /home/vault/deploy/docker-compose.yml /home/vault/docker-compose.yml"
          ssh root@${{ matrix.server.server_ip }} "cp /home/vault/deploy/Caddyfile /home/vault/"

          
          ssh root@${{ matrix.server.server_ip }} "
            cat > /home/vault/config/vault.hcl <<EOF

            storage \"raft\" {
              path    = \"/home/vault/data\"
              node_id = \"${{ matrix.server.node_id }}\"


              retry_join {
                leader_api_addr = \"https://${{ matrix.server.retry1 }}:8200\"
                leader_ca_cert_file = \"/home/tls/ca-cert.pem\"
              }

              retry_join {
                leader_api_addr = \"https://${{ matrix.server.retry2 }}:8200\"
                leader_ca_cert_file = \"/home/tls/ca-cert.pem\"
              }
            }

            listener \"tcp\" {
              address         = \"0.0.0.0:8200\"
              cluster_address = \"0.0.0.0:8201\"
              tls_disable = 0
              tls_cert_file      = \"/home/tls/${{ matrix.server.node_id }}-cert.pem\"
              tls_key_file       = \"/home/tls/${{ matrix.server.node_id }}-key.pem\"
              tls_client_ca_file = \"/home/tls/ca-cert.pem\"
            }

            ui = true

            api_addr     = \"https://${{ matrix.server.server_ip }}:8200\"
            cluster_addr = \"https://${{ matrix.server.server_ip }}:8201\"
            disable_mlock = true
          "
          ssh root@${{ matrix.server.server_ip }} "
            echo "ðŸš€ Starting Vault"
            cd /home/vault
            docker compose down || true
            SERVER_IP=${{ matrix.server.server_ip }} docker compose up -d

            echo "âœ… Vault container started on ${{ matrix.server.node_id }}"
          "
          ssh root@${{ matrix.server.server_ip }} "
            cd /home/vault
            echo '=== Container Status ==='
            docker compose ps
            echo ''
            echo '=== Vault Logs (last 20 lines) ==='
            docker compose logs --tail=20 vault 2>/dev/null || echo 'Logs not yet available'
            echo '=== Caddy Logs (last 20 lines) ==='
            docker compose logs --tail=20 caddy 2>/dev/null || echo 'Logs not yet available'
          "
    