name: Create Shared Secret and Policy

on:
  workflow_dispatch:
    inputs:
      secret_name:
        description: Secret name (e.g., shared-secret-1)'
        required: true
        type: string
      secret_value:
        description: 'Value for the secret'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  provision-secret:
    runs-on: ubuntu-latest
    env:
      VAULT_ADDR: https://vault.yral.com

    steps:
      - name: Authenticate to Vault
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ env.VAULT_ADDR }}
          method: jwt
          role: vault-service-role # Using your role with RW access
          jwtGithubAudience: "https://github.com/dolr-ai"
          exportToken: true

      - name: Install Vault CLI
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt update && sudo apt install vault

      - name: Create New Secret
        run: |
          # Writing the secret to the specified path
          # Example: secret/data/shared-secret-1 value="secret_value"
          vault kv put secret/${{ github.event.inputs.secret_name }} value="${{ github.event.inputs.secret_value }}"

      - name: Create Read-Only Policy
        run: |
          # Policy name based on the path
          POLICY_NAME="${{ github.event.inputs.secret_name }}-policy"
          
          echo "Creating policy: $POLICY_NAME"
          
          # We target secret/data/... because KV-v2 uses that internal path for ACLs
          vault policy write "$POLICY_NAME" - <<EOF
          path "secret/data/${{ github.event.inputs.secret_name }}*" {
            capabilities = ["read"]
          }
          EOF