name: Manage Shared Secret Policy

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Grant or Revoke access'
        required: true
        type: choice
        options:
          - grant
          - revoke
        default: grant
      repo_name:
        description: 'Repository name'
        required: true
        type: string
      secret_name:
        description: 'Name of the secret'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  manage-policy:
    runs-on: ubuntu-latest
    env:
      VAULT_ADDR: https://vault.yral.com

    steps:
      - name: Authenticate to Vault
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ env.VAULT_ADDR }}
          method: jwt
          role: vault-service-role
          jwtGithubAudience: "https://github.com/dolr-ai"
          exportToken: true

      - name: Install Vault CLI
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt update && sudo apt install vault

      - name: Update Role Policies
        run: |
          REPO="${{ github.event.inputs.repo_name }}"
          ROLE_NAME="${REPO}-role"
          TARGET_POLICY="${{ github.event.inputs.secret_name }}-policy"
          ACTION="${{ github.event.inputs.action }}"
          
          echo "Action: $ACTION | Role: $ROLE_NAME | Policy: $TARGET_POLICY"

          # 1. Fetch current role
          ROLE_JSON=$(vault read -format=json auth/jwt/role/$ROLE_NAME 2>/dev/null || echo "")

          if [ -z "$ROLE_JSON" ]; then
            if [ "$ACTION" == "remove" ]; then
              echo "Role not found. Nothing to remove."
              exit 0
            fi
            echo "Role not found. Creating new."
            FINAL_POLICIES="[\"$TARGET_POLICY\"]"
          else
            # 2. Process policies based on action
            if [ "$ACTION" == "grant" ]; then
              # Append and ensure uniqueness
              FINAL_POLICIES=$(echo "$ROLE_JSON" | jq -c ".data.policies + [\"$TARGET_POLICY\"] | unique")
            else
              # Remove the specific policy from the array
              FINAL_POLICIES=$(echo "$ROLE_JSON" | jq -c ".data.policies | map(select(. != \"$TARGET_POLICY\"))")
            fi
          fi

          echo "Final Policies: $FINAL_POLICIES"

          # 3. Apply changes
          vault write auth/jwt/role/$ROLE_NAME - <<EOF
          {
            "role_type": "jwt",
            "bound_audiences": ["https://github.com/dolr-ai"],
            "bound_claims_type": "glob",
            "bound_claims": {
              "repository": "dolr-ai/$REPO"
            },
            "user_claim": "actor",
            "policies": $FINAL_POLICIES,
            "ttl": "1h"
          }
          EOF