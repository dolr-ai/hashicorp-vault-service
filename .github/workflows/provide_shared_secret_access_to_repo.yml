name: Append Shared Secret Policy To Repo Role

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'Repository name'
        required: true
        type: string
      secret_name:
        description: 'Name of the secret to be added'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  append-policy:
    runs-on: ubuntu-latest
    env:
      VAULT_ADDR: https://vault.yral.com

    steps:
      - name: Authenticate to Vault
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ env.VAULT_ADDR }}
          method: jwt
          role: vault-service-role
          jwtGithubAudience: "https://github.com/dolr-ai"
          exportToken: true

      - name: Install Vault CLI
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt update && sudo apt install vault

      - name: Append Policy
        run: |
          REPO="${{ github.event.inputs.repo_name }}"
          ROLE_NAME="${REPO}-role"
          NEW_POLICY="${{ github.event.inputs.secret_name }}-policy"
          
          echo "Fetching current configuration for: $ROLE_NAME"

          # 1. Fetch existing role in JSON format
          ROLE_JSON=$(vault read -format=json auth/jwt/role/$ROLE_NAME 2>/dev/null || echo "")

          if [ -z "$ROLE_JSON" ]; then
            echo "Role $ROLE_NAME not found. Creating a new role with only the new policy."
            FINAL_POLICIES="[\"$NEW_POLICY\"]"
          else
            # 2. Use jq to extract token_policies and append the new one if it doesn't exist
            FINAL_POLICIES=$(echo "$ROLE_JSON" | jq -c ".data.policies + [\"$NEW_POLICY\"] | unique")
          fi

          echo "Final Policies Array: $FINAL_POLICIES"

          # 3. Write back the role using the JSON array format for policies
          vault write auth/jwt/role/$ROLE_NAME - <<EOF
          {
            "role_type": "jwt",
            "bound_audiences": ["https://github.com/dolr-ai"],
            "bound_claims_type": "glob",
            "bound_claims": {
              "repository": "dolr-ai/$REPO"
            },
            "user_claim": "actor",
            "policies": $FINAL_POLICIES,
            "ttl": "1h"
          }
          EOF